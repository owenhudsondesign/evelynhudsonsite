<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Upload - Evelyn Hudson</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="images/favicon.jpg" rel="shortcut icon" type="image/x-icon">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .login-container, .admin-container {
      max-width: 600px;
      margin: 40px auto;
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      font-weight: 400;
      font-size: 24px;
      margin-bottom: 30px;
    }
    h2 {
      font-weight: 400;
      font-size: 18px;
      margin-top: 30px;
      margin-bottom: 15px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    h2:first-of-type {
      border-top: none;
      padding-top: 0;
      margin-top: 0;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #666;
    }
    input[type="password"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 20px;
    }
    input[type="file"] {
      margin-bottom: 20px;
    }
    button {
      background: #333;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #555;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .error {
      color: #c00;
      margin-bottom: 20px;
    }
    .success {
      color: #080;
      margin-bottom: 20px;
    }
    .artwork-item {
      background: #f5f5f5;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    .artwork-item img {
      max-width: 200px;
      max-height: 200px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    .remove-btn {
      background: #c00;
      padding: 6px 12px;
      font-size: 14px;
    }
    .remove-btn:hover {
      background: #a00;
    }
    #artwork-list {
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      background: #f0f0f0;
      border-radius: 4px;
      margin-top: 20px;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .info {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
    <h1>Evelyn Hudson - Admin</h1>
    <label for="password">Password</label>
    <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
    <div id="login-error" class="error hidden"></div>
    <button onclick="checkPassword()">Login</button>
  </div>

  <!-- Admin Screen -->
  <div id="admin-screen" class="admin-container hidden">
    <h1>Upload Artwork</h1>

    <h2>1. Select Year</h2>
    <label for="year">Year</label>
    <select id="year">
      <option value="2024">2024</option>
      <option value="2023">2023</option>
      <option value="2022">2022</option>
      <option value="2021">2021</option>
      <option value="2020">2020</option>
      <option value="2019">2019</option>
      <option value="2018">2018</option>
      <option value="new">+ Add New Year</option>
    </select>
    <input type="text" id="new-year" class="hidden" placeholder="Enter year (e.g., 2025)">

    <h2>2. Add Artwork</h2>
    <div class="info">
      Add one or more artworks. Each artwork needs an image and a caption.<br>
      Caption format: <strong>Title, medium, dimensions</strong> (e.g., "Moon Flower, oil on canvas, 10"x10"")
    </div>

    <label for="image-input">Image</label>
    <input type="file" id="image-input" accept="image/*">

    <label for="caption-input">Caption</label>
    <input type="text" id="caption-input" placeholder='e.g., Moon Flower, oil on canvas, 10"x10"'>

    <button onclick="addArtwork()">Add to List</button>

    <h2>3. Review & Upload</h2>
    <div id="artwork-list"></div>
    <div id="upload-error" class="error hidden"></div>
    <div id="upload-success" class="success hidden"></div>
    <button id="upload-btn" onclick="uploadAll()" disabled>Upload All to Site</button>
    <div id="status" class="status hidden"></div>
  </div>

  <script src="env.js"></script>
  <script>
    // Configuration
    const CONFIG = {
      password: '2Halyardln...',
      get githubToken() { return typeof ENV !== 'undefined' ? ENV.GITHUB_TOKEN : ''; },
      owner: 'owenhudsondesign',
      repo: 'evelynhudsonsite',
      branch: 'main'
    };

    // State
    let artworks = [];

    // Password check
    function checkPassword() {
      const input = document.getElementById('password').value;
      if (input === CONFIG.password) {
        // Check if GitHub token is configured
        if (!CONFIG.githubToken || CONFIG.githubToken === 'YOUR_GITHUB_TOKEN_HERE') {
          document.getElementById('login-error').textContent = 'GitHub token not configured. Please contact Owen.';
          document.getElementById('login-error').classList.remove('hidden');
          return;
        }
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-screen').classList.remove('hidden');
      } else {
        document.getElementById('login-error').textContent = 'Incorrect password';
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    // Year selection
    document.getElementById('year').addEventListener('change', function() {
      const newYearInput = document.getElementById('new-year');
      if (this.value === 'new') {
        newYearInput.classList.remove('hidden');
      } else {
        newYearInput.classList.add('hidden');
      }
    });

    // Add artwork to list
    function addArtwork() {
      const fileInput = document.getElementById('image-input');
      const captionInput = document.getElementById('caption-input');

      if (!fileInput.files[0]) {
        alert('Please select an image');
        return;
      }
      if (!captionInput.value.trim()) {
        alert('Please enter a caption');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const artwork = {
          id: Date.now(),
          filename: file.name,
          caption: captionInput.value.trim(),
          dataUrl: e.target.result,
          file: file
        };
        artworks.push(artwork);
        renderArtworkList();

        // Clear inputs
        fileInput.value = '';
        captionInput.value = '';
      };

      reader.readAsDataURL(file);
    }

    // Render artwork list
    function renderArtworkList() {
      const list = document.getElementById('artwork-list');
      const uploadBtn = document.getElementById('upload-btn');

      if (artworks.length === 0) {
        list.innerHTML = '<p style="color:#666">No artworks added yet.</p>';
        uploadBtn.disabled = true;
        return;
      }

      uploadBtn.disabled = false;
      list.innerHTML = artworks.map(art => `
        <div class="artwork-item">
          <img src="${art.dataUrl}" alt="${art.caption}">
          <div><strong>${art.caption}</strong></div>
          <div style="color:#666;font-size:13px;margin:5px 0">${art.filename}</div>
          <button class="remove-btn" onclick="removeArtwork(${art.id})">Remove</button>
        </div>
      `).join('');
    }

    // Remove artwork
    function removeArtwork(id) {
      artworks = artworks.filter(a => a.id !== id);
      renderArtworkList();
    }

    // Status updates
    function updateStatus(msg) {
      const status = document.getElementById('status');
      status.classList.remove('hidden');
      status.textContent = msg;
    }

    // GitHub API helpers
    async function githubRequest(endpoint, options = {}) {
      const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}${endpoint}`, {
        ...options,
        headers: {
          'Authorization': `token ${CONFIG.githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'GitHub API error');
      }

      return response.json();
    }

    // Get file from GitHub
    async function getFile(path) {
      try {
        return await githubRequest(`/contents/${path}?ref=${CONFIG.branch}`);
      } catch (e) {
        return null;
      }
    }

    // Upload all artworks
    async function uploadAll() {
      const uploadBtn = document.getElementById('upload-btn');
      const errorDiv = document.getElementById('upload-error');
      const successDiv = document.getElementById('upload-success');

      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      uploadBtn.disabled = true;

      try {
        // Get year
        let year = document.getElementById('year').value;
        if (year === 'new') {
          year = document.getElementById('new-year').value.trim();
          if (!/^\d{4}$/.test(year)) {
            throw new Error('Please enter a valid 4-digit year');
          }
        }

        updateStatus('Starting upload...');

        // Upload images first
        const imageData = [];
        for (let i = 0; i < artworks.length; i++) {
          const art = artworks[i];
          updateStatus(`Uploading image ${i + 1} of ${artworks.length}: ${art.filename}`);

          // Generate unique filename
          const ext = art.filename.split('.').pop().toLowerCase();
          const timestamp = Date.now();
          const newFilename = `upload_${year}_${timestamp}_${i}.${ext}`;

          // Convert to base64 (remove data URL prefix)
          const base64 = art.dataUrl.split(',')[1];

          // Upload to GitHub
          await githubRequest(`/contents/images/${newFilename}`, {
            method: 'PUT',
            body: JSON.stringify({
              message: `Add artwork image: ${newFilename}`,
              content: base64,
              branch: CONFIG.branch
            })
          });

          imageData.push({
            filename: newFilename,
            caption: art.caption
          });
        }

        updateStatus('Images uploaded. Updating HTML page...');

        // Get or create the year page
        const pagePath = `art-${year}.html`;
        const existingPage = await getFile(pagePath);

        let pageContent;
        if (existingPage) {
          // Decode existing page
          pageContent = atob(existingPage.content);
          // Insert new artworks before the closing section tag
          const newArtworksHtml = imageData.map(img => generateArtworkHtml(img, year)).join('\n        ');
          pageContent = pageContent.replace(
            '</section>\n      <section class="page-spacer-bottom">',
            `${newArtworksHtml}\n      </section>\n      <section class="page-spacer-bottom">`
          );
        } else {
          // Create new page
          pageContent = generateFullPage(year, imageData);
        }

        // Update/create the HTML page
        await githubRequest(`/contents/${pagePath}`, {
          method: 'PUT',
          body: JSON.stringify({
            message: `Add ${artworks.length} artwork(s) to ${year}`,
            content: btoa(unescape(encodeURIComponent(pageContent))),
            branch: CONFIG.branch,
            sha: existingPage ? existingPage.sha : undefined
          })
        });

        // If new year, update navigation on all pages
        if (!existingPage) {
          updateStatus('New year created. Updating navigation...');
          await updateNavigation(year);
        }

        updateStatus('Done! Your artwork has been uploaded.');
        successDiv.textContent = `Successfully uploaded ${artworks.length} artwork(s) to ${year}. The site will update in about 1 minute.`;
        successDiv.classList.remove('hidden');

        // Clear artworks
        artworks = [];
        renderArtworkList();

      } catch (error) {
        console.error(error);
        errorDiv.textContent = `Error: ${error.message}`;
        errorDiv.classList.remove('hidden');
        updateStatus('Upload failed. See error above.');
      }

      uploadBtn.disabled = artworks.length === 0;
    }

    // Generate HTML for a single artwork
    function generateArtworkHtml(img, year) {
      const id = Math.random().toString(36).substr(2, 9);
      return `
        <div class="w-layout-blockcontainer work-item-wrapper w-container">
          <a href="#" class="w-inline-block w-lightbox"><img src="images/${img.filename}" loading="lazy" sizes="(max-width: 479px) 95vw, 40vw" alt="">
            <script type="application/json" class="w-json">{
  "items": [
    {
      "_id": "${id}",
      "origFileName": "${img.filename}",
      "fileName": "${img.filename}",
      "url": "images/${img.filename}",
      "type": "image"
    }
  ],
  "group": "${year}"
}<\/script>
          </a>
          <div class="image-caption">${escapeHtml(img.caption)}</div>
        </div>`;
    }

    // Generate full page for new year
    function generateFullPage(year, imageData) {
      const artworksHtml = imageData.map(img => generateArtworkHtml(img, year)).join('\n        ');

      return `<!DOCTYPE html>
<html data-wf-page="generated" data-wf-site="67772da882ef5fb863dffabe">
<head>
  <meta charset="utf-8">
  <title>${year}</title>
  <meta content="Evelyn Hudson's artwork from the year ${year}." name="description">
  <meta content="${year}" property="og:title">
  <meta content="Evelyn Hudson's artwork from the year ${year}." property="og:description">
  <meta content="${year}" property="twitter:title">
  <meta content="Evelyn Hudson's artwork from the year ${year}." property="twitter:description">
  <meta property="og:type" content="website">
  <meta content="summary_large_image" name="twitter:card">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/evelyn-hudsons-site.webflow.css" rel="stylesheet" type="text/css">
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);<\/script>
  <link href="images/favicon.jpg" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.jpg" rel="apple-touch-icon">
</head>
<body class="body-2">
  <section class="page-wrapper">
    <section class="main-wrapper">
      <div data-animation="default" data-collapse="tiny" data-duration="400" data-easing="ease" data-easing2="ease" data-doc-height="1" role="banner" class="nav-mobile w-nav">
        <div class="container w-container">
          <a href="#" class="w-nav-brand">
            <h3 class="heading brand-link-mobile">Evelyn Hudson</h3>
          </a>
          <nav role="navigation" class="nav-menu w-nav-menu">
            <a href="bio.html" class="nav-link-2 w-nav-link">Bio</a>
            <a href="https://www.instagram.com/evelyn_hudson/" class="nav-link-2 w-nav-link">Instagram</a>
            <a href="cv.html" class="nav-link-2 w-nav-link">CV</a>
            <a href="contact.html" class="nav-link-2 w-nav-link">Contact</a>
            <div class="w-layout-blockcontainer spacer-tiny w-container"></div>
            <div class="w-layout-blockcontainer spacer-tiny w-container"></div>
            <a href="art-2024.html" class="nav-link-2 w-nav-link">2024</a>
            <a href="art-2023.html" class="nav-link-2 w-nav-link">2023</a>
            <a href="art-2022.html" class="nav-link-2 w-nav-link">2022</a>
            <a href="art-2021.html" class="nav-link-2 w-nav-link">2021</a>
            <a href="art-2020.html" class="nav-link-2 w-nav-link">2020</a>
            <a href="art-2019.html" class="nav-link-2 w-nav-link">2019</a>
            <a href="art-2018.html" class="nav-link-2 w-nav-link">2018</a>
          </nav>
          <div class="menu-button w-nav-button">
            <div class="icon w-icon-nav-menu"></div>
          </div>
        </div>
      </div>
      <div class="w-layout-blockcontainer nav-wrapper w-container">
        <div class="w-layout-blockcontainer nav w-container">
          <h3 class="heading">
            <a href="index.html" class="heading">Evelyn Hudson</a>
          </h3>
          <a href="art-2024.html" class="nav-link">2024</a>
          <a href="art-2023.html" class="nav-link">2023</a>
          <a href="art-2022.html" class="nav-link">2022</a>
          <a href="art-2021.html" class="nav-link">2021</a>
          <a href="art-2020.html" class="nav-link">2020</a>
          <a href="art-2019.html" class="nav-link">2019</a>
          <a href="art-2018.html" class="nav-link">2018</a>
          <div class="w-layout-blockcontainer spacer-tiny w-container"></div>
          <div class="w-layout-blockcontainer spacer-tiny w-container"></div>
          <a href="bio.html" class="nav-link">Bio</a>
          <a href="https://www.instagram.com/evelyn_hudson/" target="_blank" class="nav-link">Instagram</a>
          <a href="cv.html" class="nav-link">CV</a>
          <a href="contact.html" class="nav-link">Contact</a>
        </div>
      </div>
      <section class="section-work">
        <h4 class="heading-2">${year}</h4>
        ${artworksHtml}
      </section>
      <section class="page-spacer-bottom"></section>
    </section>
  </section>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=67772da882ef5fb863dffabe" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"><\/script>
  <script src="js/webflow.js" type="text/javascript"><\/script>
</body>
</html>`;
    }

    // Update navigation on all pages (for new year)
    async function updateNavigation(newYear) {
      // This is complex - for now, we'll skip auto-updating nav
      // The user can manually add the year to navigation or we can implement this later
      console.log('Navigation update for new year would go here');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    renderArtworkList();
  </script>
</body>
</html>
